#!/bin/bash
# SPDX-License-Identifier: GPL-2.0

set -e
for f in `ls ${VERSIONING}/*`
  do
    source $f
  done
cd Packages

echo "** install toggle **"
set -x
if [ ! -d "${TOGGLE_HOME}" ]; then
  git clone --no-single-branch --depth 1 ${TOGGLE_REPOSITORY} ${TOGGLE_HOME}
fi
cd ${TOGGLE_HOME}
git pull
git checkout ${TOGGLE_BRANCH}
python setup.py clean install

# Make it writable for updates
mkdir -p /etc/toggle
cp -r configs/* /etc/toggle
chown -R octo:octo /etc/toggle/
chown -R octo:octo ${TOGGLE_HOME}/

# Provide permissions to restart toggle
echo "%octo ALL=NOPASSWD: /bin/systemctl restart toggle.service" >> /etc/sudoers.d/octo

# Install Umikaze specific systemd script
cat > /lib/systemd/system/toggle.service <<EOF
[Unit]
Description=The Redeem/Replicape Graphical user interface
After=octoprint.service sgx-startup.service
Requires=octoprint.service sgx-startup.service

[Service]
Type=simple
ExecStartPre=/bin/systemctl stop getty@tty1.service
ExecStartPre=/bin/bash -c '/bin/echo 0 > /sys/class/graphics/fbcon/cursor_blink'
ExecStart=/usr/local/bin/toggle
ExecStopPost=/bin/systemctl start getty@tty1.service
ExecStopPost=/bin/bash -c '/bin/echo 1 > /sys/class/graphics/fbcon/cursor_blink'

[Install]
WantedBy=basic.target
EOF

systemctl enable toggle
